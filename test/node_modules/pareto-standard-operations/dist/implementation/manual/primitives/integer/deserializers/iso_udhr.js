"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.$$ = void 0;
const _pds = __importStar(require("pareto-core-deserializer"));
/**
 *
 * uhdr is a numerical representation of dates where day 0 is 1948-12-10 (the date of the adoption of the Universal Declaration of Human Rights)
 *
 * This function converts an ISO 8601 date string (YYYY-MM-DD) to a udhr day number
 */
const $$ = ($, abort) => {
    const iso_day_0_offset = -711471; // the number of days that iso day 1 (0001-01-01) is offset relative to udhr day 0 (1948-12-10)
    const month_day_table_normal = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
    const month_day_table_leap = [0, 31, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335];
    const is_leap_year = (year) => (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
    const characters = _pds.text_to_character_list($);
    const parse_iso_date = (characters) => {
        const get_certain_character_at = (characters, index) => {
            return characters.__get_element_at(index).transform(($) => $, () => abort(`index out of bounds`));
        };
        const string_to_number = (characters, start, end) => {
            let result = 0;
            for (let i = start; i < end; i++) {
                const digit = get_certain_character_at(characters, i) - 48;
                if (digit < 0 || digit > 9)
                    return abort(`invalid date format`);
                result = result * 10 + digit;
            }
            return result;
        };
        const dash = 45;
        //validate format
        if (characters.get_number_of_elements() !== 10) { // YYYY-MM-DD
            return abort(`invalid date format`);
        }
        if (get_certain_character_at(characters, 4) !== dash) { // -
            return abort(`invalid date format`);
        }
        if (get_certain_character_at(characters, 7) !== dash) { // -
            return abort(`invalid date format`);
        }
        return {
            year: string_to_number(characters, 0, 4),
            month: string_to_number(characters, 5, 7),
            day: string_to_number(characters, 8, 10)
        };
    };
    const iso_date = parse_iso_date(characters);
    // Validate month (1-12)
    if (iso_date.month < 1 || iso_date.month > 12) {
        abort(`Invalid month: ${iso_date.month}. Month must be between 1 and 12`);
    }
    // Validate day (1-31, depending on month)
    if (iso_date.day < 1) {
        abort(`Invalid day: ${iso_date.day}. Day must be at least 1`);
    }
    // Check days per month
    const days_in_month = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    let max_day = days_in_month[iso_date.month - 1];
    // Adjust for leap year in February
    if (iso_date.month === 2 && is_leap_year(iso_date.year)) {
        max_day = 29;
    }
    if (iso_date.day > max_day) {
        abort(`Invalid day: ${iso_date.day}. Month ${iso_date.month} has at most ${max_day} days`);
    }
    const full_years = iso_date.year - 1;
    const leap_days_before_current_year = +_pds.integer_division(full_years, 4, () => _pds.unreachable_code_path())
        - _pds.integer_division(full_years, 100, () => _pds.unreachable_code_path())
        + _pds.integer_division(full_years, 400, () => _pds.unreachable_code_path());
    const total_days_before_current_year = full_years * 365 + leap_days_before_current_year;
    const month_days = is_leap_year(iso_date.year) ? month_day_table_leap : month_day_table_normal;
    const days_in_current_year = month_days[iso_date.month - 1] + iso_date.day;
    // Calculate total days since January 1, year 1 CE
    const total_days_since_iso_year_1 = total_days_before_current_year + days_in_current_year;
    // Convert to UDHR day number (add days from  1948-12-10)
    const udhr_day = total_days_since_iso_year_1 + iso_day_0_offset;
    return udhr_day;
};
exports.$$ = $$;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXNvX3VkaHIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvaW1wbGVtZW50YXRpb24vbWFudWFsL3ByaW1pdGl2ZXMvaW50ZWdlci9kZXNlcmlhbGl6ZXJzL2lzb191ZGhyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQ0EsK0RBQWdEO0FBSWhEOzs7OztHQUtHO0FBQ0ksTUFBTSxFQUFFLEdBQXlELENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFO0lBRWpGLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBRSxNQUFNLENBQUEsQ0FBQywrRkFBK0Y7SUFFakksTUFBTSxzQkFBc0IsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUE7SUFDdEYsTUFBTSxvQkFBb0IsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUE7SUFRcEYsTUFBTSxZQUFZLEdBQUcsQ0FBQyxJQUFZLEVBQVcsRUFBRSxDQUMzQyxDQUFDLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksR0FBRyxHQUFHLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFBO0lBRzlELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUVqRCxNQUFNLGNBQWMsR0FBRyxDQUNuQixVQUE0QixFQUNwQixFQUFFO1FBR1Ys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